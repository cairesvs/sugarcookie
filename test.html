<html>
	<head>
		<title>Test</title>
		<style type="text/css" media="screen">
			.circle {
				border: 1px solid black;
				background-color: red;
				position: absolute;
				min-height: 20px;
			}
			.box {
				border: 1px solid black;
				background-color: blue;
				position: absolute;
			}
			body {
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<div id="ball"></div>
	</body>
	<script src="protoclass.js" type="text/javascript" charset="utf-8"></script>
	<script src="box2d.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" language="javascript" charset="utf-8">
	//<![CDATA[
		Array.prototype.remove = function(index) {
			if(typeof index == 'object')
				index = this.indexOf(index);

			this[index] = this[this.length - 1];
			this.pop();
		};

		var circleId = 1;
		function Circle(world, radius) {
			(function(self) {
				self.world = world;
			 	self.radius = radius;
				var circleSd = new b2CircleDef();
				circleSd.density = 1.0;
				circleSd.radius = radius;
				circleSd.restitution = 1.0;
				circleSd.friction = 0;
				self.body = new b2BodyDef();
				self.body.AddShape(circleSd);
				self.body.position.Set(500, 500);
				self.body = world.CreateBody(self.body);
				self.body.userData = circleId++;
				self.circle = document.createElement('div');
				self.circle.className = 'circle';
				self.circle.style.width = (2 * radius) + 'px';
				self.circle.style.minHeight = (2 * radius) + 'px';
				self.circle.style.borderRadius = radius + 'px';
				self.circle.style.left = '-1000px';
				document.body.appendChild(self.circle);
			})(this);

			this.setPosition = function(x, y) {
				this.body.m_position.Set(x, y);
			};

			this.updateView = function() {
				this.circle.style.left = (this.body.m_position.x - radius) + 'px';
				this.circle.style.top = (this.body.m_position.y - radius) + 'px';
			};

			this.destroy = function() {
				world.DestroyBody(this.body);
				document.body.removeChild(this.circle);
			};
		}

		function Box(world, width, height, fixed) {
			(function(self) {
				self.world = world;
				self.width = width;
				self.height = height;
				self.box = document.createElement('div');
				self.box.className = 'box';
				self.box.style.width = (2*width) + 'px';
				self.box.style.minHeight = (2*height) + 'px';
				document.body.appendChild(self.box);
				if (typeof(fixed) == 'undefined') fixed = true;
				var boxSd = new b2BoxDef();
				if (!fixed) boxSd.density = 1.0;
				boxSd.extents.Set(width, height);
				self.body = new b2BodyDef();
				self.body.AddShape(boxSd);
			})(this);

			this.setPosition = function(x, y) {
				this.body.position.Set(x, y);
				this.body = world.CreateBody(this.body);
			};

			this.updateView = function() {
				this.box.style.left = (this.body.m_position.x - width) + 'px';
				this.box.style.top = (this.body.m_position.y - height) + 'px';
			};

			this.destroy = function() {
				world.DestroyBody(this.body);
				document.body.removeChild(this.box);
			};
		}

		function setupCannon() {
			var cannon = document.createElement('div');
			cannon.className = 'circle';
			var radius = 20;
			cannon.style.top = (window.innerHeight - radius) + 'px';
			cannon.style.width = (2 * radius) + 'px';
			cannon.style.minHeight = (2 * radius) + 'px';
			cannon.style.borderRadius = radius + 'px';
			cannon.style.zIndex = 9999;
			document.body.appendChild(cannon);

			window.addEventListener('mousemove', function(e){
				cannon.style.left = (e.clientX - radius) + 'px';
			}, false);
		}

		function animate(world, elements) {
				function animateCallback() {
					world.Step(0.016, 1);
					for (var i = 0; i < elements.length; i++) {
						elements[i].updateView();
					}
					
					if(newBall != null && newBall.body.GetContactList() && newBall.body.GetContactList().other == ceiling.body){
						newBall.destroy();
						elements.remove(newBall);
						newBall = null;
					}
					setTimeout(animateCallback, 16);
				};
				animateCallback();
		}

		var worldAABB = new b2AABB();
		worldAABB.minVertex.Set(-200, -200);
		worldAABB.maxVertex.Set(window.innerWidth + 200, window.innerHeight + 200);
		var gravity = new b2Vec2(1, 0);
		setupCannon();

		var doSleep = true;
		var world = new b2World(worldAABB, gravity, doSleep);
		world.SetFilter({
			ShouldCollide: function(shape1, shape2) {
				if (newBall == null) {
					return true;
				}
				if ((shape1.m_body == box.body && shape2.m_body == newBall.body) ||
					(shape2.m_body == box.body && shape1.m_body == newBall.body)) {
						return false;
				}
				return true;
			}
		});
		var ball = new Circle(world, 20);
		var floor = new Box(world, window.innerWidth*0.5, 5);
		var ceiling = new Box(world, window.innerWidth*0.5, 5);
		var leftWall = new Box(world, 5, window.innerHeight*0.5);
		var rightWall = new Box(world, 5, window.innerHeight*0.5);
		var newBall = null;
		ball.setPosition(100, 100);
		floor.setPosition(window.innerWidth*0.5, window.innerHeight-5);
		ceiling.setPosition(window.innerWidth*0.5, 5);
		leftWall.setPosition(5, window.innerHeight*0.5);
		rightWall.setPosition(window.innerWidth-5, window.innerHeight*0.5);

		//Box
		var box = new Box(world, 0.4 * window.innerWidth, 50);
		box.setPosition(window.innerWidth*0.5, window.innerHeight*0.5);

		var elements = [ball, floor, ceiling, leftWall, rightWall, box];
		animate(world, elements);
		setTimeout(function() {
			ball.body.ApplyImpulse(new b2Vec2(1000000, 0), new b2Vec2(100, 100));
		}, 1000);
		window.addEventListener('click', function(e) {
			if(newBall){
				return;
			}
			newBall = new Circle(world, 20);
			newBall.setPosition(e.clientX, 0.9 * window.innerHeight);
			newBall.body.ApplyImpulse(new b2Vec2(0, -2000000), new b2Vec2(e.clientX, e.clientY));
			elements.push(newBall);
		}, false);

	//]]>
	</script>
</html>
