<html>
	<head>
		<title>Test</title>
		<style type="text/css" media="screen">
			.circle {
				border: 1px solid black;
				background-color: red;
				position: absolute;
				min-height: 20px;
			}
			.box {
				border: 1px solid black;
				background-color: blue;
				position: absolute;
			}
			body {
				overflow: hidden;
			}
			#log {
				bottom: 0px;
				position: absolute;
				z-index: 99999;
				color: red;
				background: black;
			}
		</style>
	</head>
	<body>
		<div id="log"></div>
	</body>
	<script type="text/javascript" language="javascript" src="js_bintrees.min.js"></script>
	<script type="text/javascript" language="javascript" charset="utf-8">
	//<![CDATA[
		Array.prototype.remove = function(index) {
			if(typeof index == 'object')
				index = this.indexOf(index);

			this[index] = this[this.length - 1];
			this.pop();
		};

		function StraightSection(start, end) {
			this.positionAt = function(t) {
				return {
					x: start.x + (end.x - start.x) * t,
					y: start.y + (end.y - start.y) * t
				};
			}

			this.length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
		}

		CurveSectionOrientation = {
			CW: 1,
			CCW: -1
		};

		function CurveSection(center, start, angleSection, orientation) {
			this.radius = Math.sqrt(Math.pow(start.x - center.x, 2) + Math.pow(start.y - center.y, 2));
			this.length = this.radius * angleSection;
			this.initialAngle = Math.acos((start.x - center.x) / this.radius);

			if (start.y > center.y) {
				this.initialAngle += Math.PI;
			}

			this.positionAt = function(t) {
				return {
					x: center.x - Math.cos(orientation * t * angleSection + this.initialAngle) * this.radius,
					y: center.y - Math.sin(orientation * t * angleSection + this.initialAngle) * this.radius,
				};
			}
		}

		var SectionComparator = function(section1, section2) {
			if (section1.endT <= section2.initialT) {
				return -1;
			}
			if (section1.initialT >= section2.endT) {
				return 1;
			}
			return 0;
		};

		function Circuit() {
			this.sections = [];
			this.sectionsTree = new RBTree(SectionComparator);

			this.positionAt = function(t) {
				var currentSection = this.sectionsTree.find({initialT: t, endT: t});
				if (currentSection) {
					var relativeT = (t - currentSection.initialT) / currentSection.relativeLength;
					return currentSection.section.positionAt(relativeT);
				}
				return {x: 0, y: 0};
			};

			this.updateLengths = function() {
				this.totalLength = 0;
				for (var i = 0; i < this.sections.length; i++) {
					this.totalLength += this.sections[i].section.length;
				}
				var initialT = 0;
				for (var i = 0; i < this.sections.length; i++) {
					this.sections[i].relativeLength = this.sections[i].section.length / this.totalLength;
					this.sections[i].initialT = initialT;
					initialT += this.sections[i].relativeLength;
					this.sections[i].endT = initialT;
				}
			};

			this.addSection = function(section) {
				this.sections.push({section: section});
				this.updateLengths();
				this.sectionsTree.insert(this.sections[this.sections.length - 1]);
			};

			this.toRelativeDistance = function(absoluteDistance) {
				return absoluteDistance / this.totalLength;
			};
		}

		function Circle(radius) {
			this.updateView = function() {
				this.circle.style.left = (this.x - radius) + 'px';
				this.circle.style.top = (this.y - radius) + 'px';
			};

			this.setPosition = function(position) {
				var lastX = this.x;
				var lastY = this.y;
				this.x = position.x;
				this.y = position.y;
				var v = Math.sqrt(Math.pow(lastX - this.x, 2) + Math.pow(lastY - this.y, 2));
				document.getElementById('log').innerHTML = "v=" + v;
				this.updateView();
			};

			(function(self) {
				self.circle = document.createElement('div');
				self.circle.className = 'circle';
				self.circle.style.width = (2 * radius) + 'px';
				self.circle.style.minHeight = (2 * radius) + 'px';
				self.circle.style.borderRadius = radius + 'px';
				self.circle.style.left = '-1000px';
				self.setPosition(0);
				document.body.appendChild(self.circle);
			})(this);

			this.destroy = function() {
				document.body.removeChild(this.circle);
			};
		}

		function Box(width, height) {
			(function(self) {
				self.x = 0;
				self.y = 0;
				self.width = width;
				self.height = height;
				self.box = document.createElement('div');
				self.box.className = 'box';
				self.box.style.width = width + 'px';
				self.box.style.minHeight = height + 'px';
				document.body.appendChild(self.box);
			})(this);
			
			this.updateView = function() {
				this.box.style.left = (this.x - width*0.5) + 'px';
				this.box.style.top = (this.y - height*0.5) + 'px';
			};

			this.setPosition = function(x, y) {
				this.x = x;
				this.y = y;
				this.updateView();
			};

			this.destroy = function() {
				document.body.removeChild(this.box);
			};
		}

		function setupCannon() {
			var cannon = document.createElement('div');
			cannon.className = 'circle';
			var radius = 20;
			cannon.style.top = (window.innerHeight - radius) + 'px';
			cannon.style.width = (2 * radius) + 'px';
			cannon.style.minHeight = (2 * radius) + 'px';
			cannon.style.borderRadius = radius + 'px';
			cannon.style.zIndex = 9999;
			document.body.appendChild(cannon);

			window.addEventListener('mousemove', function(e){
				cannon.style.left = (e.clientX - radius) + 'px';
			}, false);
		}

		//setupCannon();

		var balls = [new Circle(20), new Circle(20), new Circle(20)];
		var floor = new Box(window.innerWidth, 10);
		var ceiling = new Box(window.innerWidth, 10);
		var leftWall = new Box(10, window.innerHeight);
		var rightWall = new Box(10, window.innerHeight);
		var circuit = new Circuit();
		circuit.addSection(new StraightSection({x: 200, y: 100}, {x: 500, y: 100}));
		circuit.addSection(new CurveSection({x: 500, y: 200}, {x: 500, y: 100}, Math.PI, CurveSectionOrientation.CW));
		circuit.addSection(new StraightSection({x: 500, y: 300}, {x: 200, y: 300}));
		circuit.addSection(new CurveSection({x: 200, y: 400}, {x: 200, y: 300}, Math.PI, CurveSectionOrientation.CCW));
		circuit.addSection(new StraightSection({x: 200, y: 500}, {x: 500, y: 500}));
		circuit.addSection(new StraightSection({x: 500, y: 500}, {x: 700, y: 300}));
		floor.setPosition(window.innerWidth*0.5, window.innerHeight-5);
		ceiling.setPosition(window.innerWidth*0.5, 5);
		leftWall.setPosition(5, window.innerHeight*0.5);
		rightWall.setPosition(window.innerWidth-5, window.innerHeight*0.5);

		function updateAllBalls(t) {
			var relativeDistance = circuit.toRelativeDistance(40);
			for (var i = 0; i < balls.length; i++) {
				balls[i].setPosition(circuit.positionAt(t - i * relativeDistance));
			}
		}

		//window.addEventListener('mousemove', function(e) {
		//	t = e.clientY / window.innerHeight;
		//	updateAllBalls(t);
		//}, false);

		var t = 0;
		setInterval(function() {
			t += 0.005;
			updateAllBalls(t);
			if (t > 1) t = 0.0;
		}, 16);
	//]]>
	</script>
</html>
